<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    
    <title>移动端风格化SSR水体 | Joon Portfolio</title>

    <meta name="description" content="&lt;blockquote&gt;
&lt;p&gt;此文之前已在其他平台发布过一次了，博客上的版本就好好排下版，然后行文更偏实用主义一点。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&#34;前言：&#34;&gt;&lt;a href=&#34;#前言：&#34; class=&#34;headerlink&#34; title=&#34;前言：&#34;&gt;&lt;/a&gt;前言：&lt;/h1&gt;&lt;p&gt;做这玩意的动机，主要是公司有这样的需求，又没找着合适改造的轮子，遂自己开发，也是一种学习。&lt;/p&gt;
&lt;p&gt;性能上的要求是移动端能跑（米10为基准），那固然不能用真实感的ssr算法，得用一些hack来简化算法。至于能从哪些方面对算法进行简化，那不妨先观察一下，真实世界的水体：&lt;/p&gt;">
    <meta name="keywords" content="">

    

    <meta property="og:locale" content="zh-CN" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content= "移动端风格化SSR水体 | Joon Portfolio"  />
    <meta property="og:description" content= "&lt;blockquote&gt;
&lt;p&gt;此文之前已在其他平台发布过一次了，博客上的版本就好好排下版，然后行文更偏实用主义一点。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&#34;前言：&#34;&gt;&lt;a href=&#34;#前言：&#34; class=&#34;headerlink&#34; title=&#34;前言：&#34;&gt;&lt;/a&gt;前言：&lt;/h1&gt;&lt;p&gt;做这玩意的动机，主要是公司有这样的需求，又没找着合适改造的轮子，遂自己开发，也是一种学习。&lt;/p&gt;
&lt;p&gt;性能上的要求是移动端能跑（米10为基准），那固然不能用真实感的ssr算法，得用一些hack来简化算法。至于能从哪些方面对算法进行简化，那不妨先观察一下，真实世界的水体：&lt;/p&gt;" />
    <meta property="og:url" content="https://gaplegth.github.io/2022/12/27/npr-water/index.html" />
    <meta property="og:site_name" content="" />
    <meta property="article:author" content="JoonYu" />
    <meta property="article:publisher" content="" />
    <meta property="og:description" content="&lt;blockquote&gt;
&lt;p&gt;此文之前已在其他平台发布过一次了，博客上的版本就好好排下版，然后行文更偏实用主义一点。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&#34;前言：&#34;&gt;&lt;a href=&#34;#前言：&#34; class=&#34;headerlink&#34; title=&#34;前言：&#34;&gt;&lt;/a&gt;前言：&lt;/h1&gt;&lt;p&gt;做这玩意的动机，主要是公司有这样的需求，又没找着合适改造的轮子，遂自己开发，也是一种学习。&lt;/p&gt;
&lt;p&gt;性能上的要求是移动端能跑（米10为基准），那固然不能用真实感的ssr算法，得用一些hack来简化算法。至于能从哪些方面对算法进行简化，那不妨先观察一下，真实世界的水体：&lt;/p&gt;" />
    <meta name="twitter:title" content="移动端风格化SSR水体 | Joon Portfolio"/>
    <meta name="twitter:description" content="&lt;blockquote&gt;
&lt;p&gt;此文之前已在其他平台发布过一次了，博客上的版本就好好排下版，然后行文更偏实用主义一点。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&#34;前言：&#34;&gt;&lt;a href=&#34;#前言：&#34; class=&#34;headerlink&#34; title=&#34;前言：&#34;&gt;&lt;/a&gt;前言：&lt;/h1&gt;&lt;p&gt;做这玩意的动机，主要是公司有这样的需求，又没找着合适改造的轮子，遂自己开发，也是一种学习。&lt;/p&gt;
&lt;p&gt;性能上的要求是移动端能跑（米10为基准），那固然不能用真实感的ssr算法，得用一些hack来简化算法。至于能从哪些方面对算法进行简化，那不妨先观察一下，真实世界的水体：&lt;/p&gt;"/>
    <script type="application/ld+json">
        {
            "description": "&lt;blockquote&gt;
&lt;p&gt;此文之前已在其他平台发布过一次了，博客上的版本就好好排下版，然后行文更偏实用主义一点。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&#34;前言：&#34;&gt;&lt;a href=&#34;#前言：&#34; class=&#34;headerlink&#34; title=&#34;前言：&#34;&gt;&lt;/a&gt;前言：&lt;/h1&gt;&lt;p&gt;做这玩意的动机，主要是公司有这样的需求，又没找着合适改造的轮子，遂自己开发，也是一种学习。&lt;/p&gt;
&lt;p&gt;性能上的要求是移动端能跑（米10为基准），那固然不能用真实感的ssr算法，得用一些hack来简化算法。至于能从哪些方面对算法进行简化，那不妨先观察一下，真实世界的水体：&lt;/p&gt;",
            "author": { "@type": "Person", "name": "JoonYu" },
            "@type": "BlogPosting",
            "url": "https://gaplegth.github.io/2022/12/27/npr-water/index.html",
            "publisher": {
            "@type": "Organization",
            "logo": {
                "@type": "ImageObject",
                "url": "https://gaplegth.github.ioundefined"
            },
            "name": "JoonYu"
            },
            "headline": "移动端风格化SSR水体 | Joon Portfolio",
            "datePublished": "2022-12-27T15:23:31.000Z",
            "mainEntityOfPage": {
                "@type": "WebPage",
                "@id": "https://gaplegth.github.io/2022/12/27/npr-water/index.html"
            },
            "@context": "http://schema.org"
        }
    </script>




    

    

    

    

    

    

    

    
<link rel="stylesheet" href="/dist/build.css?v=1654266144177.css">


    
<link rel="stylesheet" href="/dist/custom.css?v=1654266144177.css">


    <script>
        window.isPost = true
        window.aomori = {
            
            
            
        }
        window.aomori_logo_typed_animated = true
        window.aomori_search_algolia = false

    </script>

<meta name="generator" content="Hexo 6.3.0"></head>

<body>

    <div class="container">
    <header class="header">
        <div class="header-type">
            
            <div class="header-type-inner">
                
                    <div id="typed-strings" style="display:none">
                        <p>Joon Portfolio</p>
                    </div>
                    <a class="header-type-title" id="typed" href="/"></a>
                
    
                
            </div>
        </div>
        <div class="header-menu">
            <div class="header-menu-inner">
                
                <a href="/">首页</a>
                
                <a href="/archives">存档</a>
                
                <a href="/photography">摄影</a>
                
            </div>
            <div class="header-menu-social">
                
    <a class="social" target="_blank" href="https://www.linkedin.com/in/joon-yu-1110b7198/">
        <ion-icon name="logo-linkedin"></ion-icon>
    </a>

    <a class="social" target="_blank" href="mailto:gaplegth@163.com">
        <ion-icon name="mail-outline"></ion-icon>
    </a>

            </div>
        </div>

        <div class="header-menu-mobile">
            <div class="header-menu-mobile-inner" id="mobile-menu-open">
                <i class="icon icon-menu"></i>
            </div>
        </div>
    </header>

    <div class="header-menu-mobile-menu">
        <div class="header-menu-mobile-menu-bg"></div>
        <div class="header-menu-mobile-menu-wrap">
            <div class="header-menu-mobile-menu-inner">
                <div class="header-menu-mobile-menu-close" id="mobile-menu-close">
                    <i class="icon icon-cross"></i>
                </div>
                <div class="header-menu-mobile-menu-list">
                    
                    <a href="/">首页</a>
                    
                    <a href="/archives">存档</a>
                    
                    <a href="/photography">摄影</a>
                    
                </div>
            </div>
        </div>
    </div>

</div>

    <div class="container">
        <div class="main">
            <section class="inner">
                <section class="inner-main">
                    <div class="post">
    <article id="post-cldkl2aqx0006qwu52grk897i" class="article article-type-post" itemscope
    itemprop="blogPost">

    <div class="article-inner">

        
          

<div class="swiper-container article-gallery">
  <div class="swiper-wrapper">
    
      <div class="swiper-slide">
        <img src="https://gaplegth-blog.oss-cn-shanghai.aliyuncs.com/topic.png" itemprop="image">
      </div>
    
  </div>
  <!-- 如果需要分页器 -->
  <div class="swiper-pagination"></div>
</div>


        
        
        

        
        <header class="article-header">
            
  
    <h1 class="article-title" itemprop="name">
      移动端风格化SSR水体
    </h1>
  

        </header>
        

        <div class="article-more-info article-more-info-post hairline">

            <div class="article-date">
  <time datetime="2022-12-27T15:23:31.000Z" itemprop="datePublished">2022-12-27</time>
</div>

            
            <div class="article-category">
                <a class="article-category-link" href="/categories/%E6%B8%B2%E6%9F%93/">渲染</a>
            </div>
            

            
            <div class="article-tag">
                <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/NPR/" rel="tag">NPR</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/URP/" rel="tag">URP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Unity/" rel="tag">Unity</a></li></ul>
            </div>
            

            
            <div class="article-busuanzi">
                <span id="busuanzi_value_page_pv">N</span> 人看过
            </div>
            

        </div>

        <div class="article-entry post-inner-html hairline" itemprop="articleBody">
            <blockquote>
<p>此文之前已在其他平台发布过一次了，博客上的版本就好好排下版，然后行文更偏实用主义一点。</p>
</blockquote>
<h1 id="前言："><a href="#前言：" class="headerlink" title="前言："></a>前言：</h1><p>做这玩意的动机，主要是公司有这样的需求，又没找着合适改造的轮子，遂自己开发，也是一种学习。</p>
<p>性能上的要求是移动端能跑（米10为基准），那固然不能用真实感的ssr算法，得用一些hack来简化算法。至于能从哪些方面对算法进行简化，那不妨先观察一下，真实世界的水体：</p>
<span id="more"></span>

<center>
<img src="https://gaplegth-blog.oss-cn-shanghai.aliyuncs.com/night.jpeg" width=100%>

<p><font color=gray>摄于古水北镇，慢门拍摄</font></p>
</center>

<p>可以观察到，真实世界中，带着轻微波浪的水反射成像已经基本上看不清实际的反射物，而只有轻微的轮廓。总结起来，就是咱可以降分辨率了。</p>
<center>
<img src="https://gaplegth-blog.oss-cn-shanghai.aliyuncs.com/cambridge.jpeg" width=100%>

<p><font color=gray>摄于剑桥</font></p>
</center>

<p>从第二张图可以观察到，水体反射还有一个特点就是，对于远处的水面，我们的观察角度非常接近掠射角，从而导致水面细小的起伏都能对反射造成很大的干扰，同时也会使得视觉上感知到水面的高光更加密集。在这两点同时作用下，越远的倒影会越容易被高光遮盖，同时也会更加的模糊扭曲。这一点在实现水体反射的时候也可以考虑进去。</p>
<p>接下来，分析一下咱们所能使用的技术。很凑巧，上个月（2022年11月）发布的骁龙8gen2和天玑9200，都相继实现了“移动硬光追”。笔者目前还没在这些设备上测试过光追性能，只是听业界朋友说，由于手机功耗限制，光追的性能非常受限。而软光追，我认为短时间内也不可能有实际应用，或许目前最大的盼头就是看UE5什么时候能在手机上跑Lumen。既然真正的场景光追跑不了，那咱们只能把希望寄托在光栅化就能实现的屏幕空间反射（Screen Space Reflection，SSR）上了。</p>
<blockquote>
<p>PS：其实也考虑过平面反射，但是与项目沟通之后考虑到大场景开发迭代中管理反射物会比较麻烦，故没有使用。不过这也是一个水面反射常用的实现手段，特别对于小场景来说很好用。</p>
</blockquote>
<p>对于这个概念不熟悉的读者，建议先在网上了解一下相关知识。在这里推荐一下闫令琪老师的GAMES202，看完之后可以对现代实时光追技术有一个宏观的了解。要在工程上实现一个能用的SSR水体，那自然不止要写SSR和水体渲染就行。为了更好地平衡性能和表现，咱们还需要进行很多其他处理，以及与现有的管线进行适配，和已有效果进行正确的叠加混合，有可能的话进行rt的复用。分析表现需求，将其转化为渲染逻辑的思考过程往往妙趣横生，但是真的开始实现的时候，不免枯燥乏味，令人抓狂。从此往后，笔者会注重于整个实现的思路介绍，一些工程上的实现细节以及一些趟出来的坑，希望能对想要实现类似效果的开发者们有所帮助。</p>
<p>本次使用的是Unity 2021.3.5，URP 12.1.7版本，延迟管线，基于URP的RenderFeature接口实现。先放个视频看看最终的效果（场景素材来自网络）：</p>
<iframe src="//player.bilibili.com/player.html?aid=608542366&bvid=BV1Y84y1L7ao&cid=985733366&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" width=100% height="500"> </iframe>

<p>性能方面，在移动端（米10为基准）复杂场景打包测试中，此效果的开关对于帧率基本没有影响，苹果机器测试出的消耗甚至不足一毫秒。并且由于目前还在造轮子阶段，为了方便后续移植，一些可以集成到管线中的代码写在了外部，项目实际使用时可以进行进一步优化。</p>
<p>总的实现流程如下图，接下来开始逐步介绍：</p>
<center>
<img src="https://gaplegth-blog.oss-cn-shanghai.aliyuncs.com/order.png" width=100%>
</center>

<hr>

<h1 id="具体实现："><a href="#具体实现：" class="headerlink" title="具体实现："></a>具体实现：</h1><h2 id="定时渲染天空Cubemap："><a href="#定时渲染天空Cubemap：" class="headerlink" title="定时渲染天空Cubemap："></a>定时渲染天空Cubemap：</h2><p>渲这玩意呢主要是为了适配TOD（time of day，即动态的天空大气）系统。</p>
<p>众所周知，所谓屏幕空间，就是咱们只能拿到屏幕上的信息。楼太高了超出屏幕上沿了，那底下的反射也会被截断了。以往为了弥补这种瑕疵，大家一般是采样一张cubemap填补超出屏幕的部分，或者直接就让反射逐渐消失完事。而带着TOD的时候，这张cubemap就不能是离线烘好的，而是得实时渲染。</p>
<p>在Unity中，实时渲染cubemap大概有两种做法：新建一个CullingMask只有天空盒的相机，调用RenderToCubemap函数，优先主相机定时渲染一张rt；以及在RenderFeature里用V矩阵模拟六个方向的相机渲到一张rt上。第二个方法其实就是自己在RenderFeature里实现一遍RenderToCubemap函数，更底层一点，最重要是移植性更好，组织结构更清晰。性能上笔者没有测试过，但猜测两种实现应该都差不多。这里用的是第二种实现，上代码：</p>
<pre><code class="csharp">Matrix4x4 customV, customP;
drawSkyboxCmd.EnableShaderKeyword(&quot;CY_HEIGHT_FOG_SKY&quot;);
CalCubeProjectMatrix(drawSkyboxCmd, out customP);

for (int i = 0; i &lt; 6; i++)
&#123;
    CalCubeViewMatrixAndSetTarget(i, renderingData, drawSkyboxCmd, out customV);
    var cubeCullingResults = CalCubeCullResult(renderingData, context, customV, customP);
    context.ExecuteCommandBuffer(drawSkyboxCmd);
    drawSkyboxCmd.Clear();
    context.DrawRenderers(cubeCullingResults, ref drawSettings, ref m_FilteringSettings, ref m_RenderStateBlock);
&#125;
drawSkyboxCmd.DisableShaderKeyword(&quot;CY_HEIGHT_FOG_SKY&quot;);
Matrix4x4 oriViewMatrix = renderingData.cameraData.camera.worldToCameraMatrix;
Matrix4x4 oriProjMatrix = renderingData.cameraData.camera.projectionMatrix;
drawSkyboxCmd.SetViewProjectionMatrices(oriViewMatrix, oriProjMatrix);
</code></pre>
<center>
<font color=gray>Execute中的代码
</font>
</center>
<br>

<pre><code class="csharp">void CalCubeViewMatrixAndSetTarget(int faceID, RenderingData rD, CommandBuffer cmd, out Matrix4x4 customV)
&#123;
    Vector3 rotEular;
    CubemapFace cubemapFace;

    switch(faceID)
    &#123;
        case 0:
            rotEular = new Vector3(0, 90, 0);
            cubemapFace = CubemapFace.PositiveX;
            break;
        case 1:
            rotEular = new Vector3(0, -90, 0);
            cubemapFace = CubemapFace.NegativeX;
            break;
        case 2:
            rotEular = new Vector3(-90, 0, 0);
            cubemapFace = SystemInfo.graphicsUVStartsAtTop ? CubemapFace.PositiveY : CubemapFace.NegativeY;
            break;
        case 3:
            rotEular = new Vector3(90, 0, 0);
            cubemapFace = SystemInfo.graphicsUVStartsAtTop ? CubemapFace.NegativeY : CubemapFace.PositiveY;
            break;
        case 4:
            rotEular = new Vector3(0, 0, 0);
            cubemapFace = CubemapFace.PositiveZ;
            break;
        default:
            rotEular = new Vector3(0, 180, 0);
            cubemapFace = CubemapFace.NegativeZ;
            break;
    &#125;

    customV = ViewMatrixByEularRot(rotEular, rD.cameraData.worldSpaceCameraPos);
    cmd.SetViewMatrix(customV);
    cmd.SetRenderTarget(skyCubeRT, 0, cubemapFace);
&#125;
</code></pre>
<center>
<font color=gray>计算六向V矩阵，主要的坑在api不同的时候rt对应的面不同。
</font>
</center>
<br>

<pre><code class="csharp">Matrix4x4 ViewMatrixByEularRot(Vector3 eularRot, Vector3 camPos)
&#123;
    Quaternion rotQ = Quaternion.Euler(eularRot);
    Matrix4x4 customV = Matrix4x4.TRS(camPos, rotQ, Vector3.one);
    customV = customV.inverse;

    //if (SystemInfo.usesReversedZBuffer)
    //&#123;
        customV.m20 = -customV.m20;
        customV.m21 = -customV.m21;
        customV.m22 = -customV.m22;
        customV.m23 = -customV.m23;
    //&#125;

    return customV;
&#125;
</code></pre>
<center>
<font color=gray>需要手动反z。
</font>
</center>
<br>

<p>坑基本都是些api适配啥的。这里一个还能优化的点是目前裁剪裁了六次，属于是不知道怎么让管线不进行裁剪的下策。而我试过用fov为179度的矩阵去裁一次，得到的结果也不理想，猜测是fov太大了远裁变形了。如果哪位大佬知道怎么关闭裁剪还请麻烦赐教，感谢感谢。</p>
<hr>

<h2 id="渲染半分辨率深度："><a href="#渲染半分辨率深度：" class="headerlink" title="渲染半分辨率深度："></a>渲染半分辨率深度：</h2><p>由于咱们对于反射质量要求不高，所以降一半分辨率目前在效果上看没啥问题。而为了能走earlyZ，SSR渲染的时候绑的深度rt也得是半分辨率的。这一步要注意的是得判断下reversed_z，来确定计算深度保守值时该取最大值还是最小值。</p>
<hr>

<h2 id="基于模型SSR计算："><a href="#基于模型SSR计算：" class="headerlink" title="基于模型SSR计算："></a>基于模型SSR计算：</h2><p>终于来到了重点部分。随着屏幕空间的各种技术发展，SSR的计算方法也在不断地迭代优化，总的来说就是更少的循环次数，更好的效果。但如前文所说，性能和质量本身就是不可兼得的，所以咱们得做出取舍。</p>
<p>目前的SSR做法要点是：视空间步进，不做重要性采样，采样直接采颜色而不是BRDF参数，无论有没有通过深度求交都进行采样。可以说是和传统SSR的做法大不相同了。用到的优化方法只有常用的jitter，即给逐片元射线的步长加上一个随机数，使得低步进次数造成的横条状变成分布较为均匀的点（在视觉上会觉得图像更为连续），从而达到降低步进次数的目的。</p>
<p>之前也试过屏幕空间步进的方法，但是就算使用了jitter也会采样出一道一道的明显横线，猜测是屏幕空间步进算法本身导致的。不过现在视空间设置最大步进8次就能达到效果，性能也不错，效果比屏幕空间的好，就没折腾了。至于Hiz的优化，涉及到整体管线的设计，同时也需要其他相关功能的优化和复用，属于是得给整个管线捋一遍的工作量，暂时没有进行。</p>
<p>至于为什么无论有没有通过求交都采样呢，是因为想要采样到实时的天空。而天空渲染在远裁，真通过射线打到远裁那射线步长和最大循环不得大到姥姥家，性能上不可能允许……而不判断求交会产生的问题，就是远处的物体反射会被拉长，如图：</p>
<center>
<img src="https://gaplegth-blog.oss-cn-shanghai.aliyuncs.com/far_flaw.png" width=100%>
</center>

<p>产生这样的原因，是射线太短了。比如离相机近的水面理应采样树林上面的天空，但是射线根本走不了这么远。知道原因之后，要弥补就好办了，咱们让离相机近的像素发出的射线步长更长就好了：</p>
<pre><code class="GLSL">float strideScaler = 1.0 - min( 1.0, -rayOriginVS.z / _PixelStrideZCuttoff);
float dStep = jitter + (abs(rayLength) / _MaxScreenNum);
dStep *= (1 + strideScaler);
</code></pre>
<p>_PixelStrideZCutoff为可调的参数(rayOriginVS.z本身为负数)，这么做就可以大致解决远视距拉伸的问题。</p>
<p>在视频中可以看到，这里做了一个反射效果随着视角变化的渐变过渡。关于这个渐变过渡遮罩生成，核心的判断条件是，像素离屏幕下左右三个边的距离、射线打到的位置实际深度、以及射线打到的位置离屏幕上沿的距离。同时，还使用了相机俯仰旋转和相机离水面高度作为输入。在映射的时候，主要是smoothstep和pow来控制效果变化，最后得到的渐变值保存在SSR绑定rt的a通道中。</p>
<p>最后要提一下的是关于Unity各个空间转换的坑。一开始解决这玩意以及api适配花了大量的时间精力去debug。一个比较坑的是在片元里通过屏幕坐标和裁剪的z重建视空间坐标：</p>
<pre><code class="GLSL">inline float3 ScreenSpaceToViewSpacePos(float2 ssUV, float zBufferDep)
&#123;
    #if UNITY_REVERSED_Z
        zBufferDep = 1 - zBufferDep;
    #endif

    zBufferDep = zBufferDep * 2.0 - 1.0;

    //modify from ComputeViewSpacePosition()
    float4 positionCS = ComputeClipSpacePosition(ssUV, zBufferDep);
    float4 positionVS = mul(unity_CameraInvProjection, positionCS);
    float3 vPos = positionVS.xyz / positionVS.w;

    #if UNITY_UV_STARTS_AT_TOP
        vPos.y = -vPos.y;
    #endif

    return vPos;
&#125;
</code></pre>
<p>重点在要对zbuffer的深度也进行映射,而Unity自带的相关api都没有封装这一句……唯一一个实现在动态模糊的shader里，偶然之间发现：</p>
<pre><code class="GLSL">half2 GetCameraVelocity(float4 uv)
&#123;
    float depth = SAMPLE_TEXTURE2D_X(_CameraDepthTexture, sampler_PointClamp, uv.xy).r;

#if UNITY_REVERSED_Z
    depth = 1.0 - depth;
#endif

    depth = 2.0 * depth - 1.0;

    float3 viewPos = ComputeViewSpacePosition(uv.zw, depth, unity_CameraInvProjection);
    float4 worldPos = float4(mul(unity_CameraToWorld, float4(viewPos, 1.0)).xyz, 1.0);
    float4 prevPos = worldPos;

    float4 prevClipPos = mul(_PrevViewProjM, prevPos);
    float4 curClipPos = mul(_ViewProjM, worldPos);

    half2 prevPosCS = prevClipPos.xy / prevClipPos.w;
    half2 curPosCS = curClipPos.xy / curClipPos.w;

    return ClampVelocity(prevPosCS - curPosCS, _Clamp);
&#125;
</code></pre>
<p>实在是很神秘。到头来主要还是难以debug出封装的矩阵里头干了啥。</p>
<hr>

<h2 id="抖动采样："><a href="#抖动采样：" class="headerlink" title="抖动采样："></a>抖动采样：</h2><p>这一步，是为了弥补屏幕空间的信息不足。由于水进行扰动之后，采样的坐标会移动，而如果咱们渲SSR的时候中间有个东西挡住了场景，得到的结果中间就会有一个黑色区域。如果不处理，就会如下图：</p>
<center>
<img src="https://gaplegth-blog.oss-cn-shanghai.aliyuncs.com/shake1.png" width=100%>
</center>

<center>
<img src="https://gaplegth-blog.oss-cn-shanghai.aliyuncs.com/shake1.png" width=100%>
</center>

<p>弥补的方法，就是判断当前像素是黑色的话，就往左右移动uv采样。移动的距离和次数与水体法线扰动程度有关。得到的结果如图：</p>
<center>
<img src="https://gaplegth-blog.oss-cn-shanghai.aliyuncs.com/shake3.png" width=100%>
</center>

<p>这是对于中间黑两头有颜色的处理方法。如果只进行这样的判断，一些情况下会出现不需要的颜色：</p>
<center>
<img src="https://gaplegth-blog.oss-cn-shanghai.aliyuncs.com/shake5.png" width=100%>
</center>

<center>
<img src="https://gaplegth-blog.oss-cn-shanghai.aliyuncs.com/shake4.png" width=100%>
</center>

<p>对于中间有颜色两头黑的情况，就得比较取巧的判断了。目前做法是左右采样采到颜色之后，往反方向继续采样，如果采样到了颜色再对当前像素进行赋值。这样做依然不能解决所有抖动采样出现的问题，但起码能解决一部分。</p>
<hr>

<h2 id="水体渲染："><a href="#水体渲染：" class="headerlink" title="水体渲染："></a>水体渲染：</h2><p>这个部分的做法，就是各家有各家的美术要求，风格化嘛，解决方案没有什么标准。这里的实现由于不需要表现波涛汹涌的水面，所以没有加入顶点偏移。大概总结一下一些实现的效果：深浅水颜色，岸边泡沫，使用Worley噪声的焦散，Blinn-Phone高光，两张法线图叠加扰动，菲涅尔混合反射折射。其中前三个需设置深度阈值。以及关于前面提到的距离越远扰动越剧烈，可以把法线扰动偏移和深度建立函数关系，至于多远想要扰动多剧烈设置一个参数调节就好了。</p>
<p>值得提一下的是反射部分。如前文所说，咱们现在有一张每隔一段时间刷新一次的天空盒cubemap，以及通过SSR得到的实时反射rt。这两张rt是通过之前计算的ssr渐变遮罩值来混合的，他们共同组成咱们水面的反射颜色。具体的效果就是，反射物超出屏幕的部分，会替换成定时刷新的天空，配合TOD系统和雾效，整体观感是比较自然的。</p>
<p>其他部分的具体实现，网络上有大量的文章任君挑选，代码基本都是现成的，工作量主要是在对美术表现和渲染语言之间的翻译上。按我这边实现的过程来看，全都是一些渐变过渡效果，勤用smoothstep、pow和lerp，设置一大堆可以调节的阈值，完活。</p>
<hr>

<p>分享到这里就结束了。这一套东西一路做下来，能达到现在的效果和性能，离不开几位引擎大佬的帮助，我也是受益良多，在这里对他们表达最诚挚的谢意！同时，也深感渲染领域还有太多太多的东西值得去学习。道阻且长，行则将至，与君共勉！</p>
<p>本文权当抛砖引玉，如果上文有任何错误的地方，或者有更好的做法，还请不吝赐教，感谢您的阅读！</p>

        </div>

    </div>

    

    

    

    
  <div class="article-copyright hairline">
    <p>
      本作品采用  <a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc-nd/4.0/">知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议 (CC BY-NC-ND 4.0)</a> 进行许可。
    </p>
  </div>
  

    

    
<nav class="article-nav">
  
    <a href="/2023/01/29/procedural-terrain/" id="article-nav-newer" class="article-nav-link-wrap">
      <div class="article-nav-caption">下一篇</div>
      <div class="article-nav-title">
        
          程序化岩石包边
        
      </div>
    </a>
  
  
    <a href="/2021/08/25/road-editor/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-caption">上一篇</div>
      <div class="article-nav-title">路网生成器</div>
    </a>
  
</nav>


    <section class="share">
        <div class="share-title">分享</div>
        <a class="share-item" target="_blank"
            href="https://twitter.com/share?text=移动端风格化SSR水体 - Joon Portfolio&url=https%3A%2F%2Fgaplegth.github.io%2F2022%2F12%2F27%2Fnpr-water%2F">
            <ion-icon name="logo-twitter"></ion-icon>
        </a>
        <a class="share-item" target="_blank"
            href="https://www.facebook.com/sharer.php?title=移动端风格化SSR水体 - Joon Portfolio&u=https%3A%2F%2Fgaplegth.github.io%2F2022%2F12%2F27%2Fnpr-water%2F">
            <ion-icon name="logo-facebook"></ion-icon>
        </a>
        <!-- <a class="share-item" target="_blank"
            href="https://service.weibo.com/share/share.php?title=移动端风格化SSR水体 - Joon Portfolio&url=https://gaplegth.github.io/2022/12/27/npr-water/&pic=">
            <div class="n-icon n-icon-weibo"></div>
        </a> -->
    </section>

</article>
















<script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

</div>
                </section>
            </section>

            
            <aside class="sidebar ">
                


<div class="widget" id="widget">
    
      
  <div class="widget-wrap">
    <div class="widget-inner">
      <div class="toc post-toc-html"></div>
    </div>
  </div>

    
      
  <div class="widget-wrap widget-cate">
    <div class="widget-title"><span>Categories</span></div>
    <div class="widget-inner">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B8%B2%E6%9F%93/">渲染</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%A8%8B%E5%BA%8F%E5%8C%96%E5%BB%BA%E6%A8%A1/">程序化建模</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BE%8E%E6%9C%AF/">美术</a></li></ul>
    </div>
  </div>


    
      
  <div class="widget-wrap widget-tags">
    <div class="widget-title"><span>Tags</span></div>
    <div class="widget-inner">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Buildin/" rel="tag">Buildin</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Houdini/" rel="tag">Houdini</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Maya/" rel="tag">Maya</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NPR/" rel="tag">NPR</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PBR/" rel="tag">PBR</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PDG/" rel="tag">PDG</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Substance-Designer/" rel="tag">Substance Designer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Substance-Painter/" rel="tag">Substance Painter</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/URP/" rel="tag">URP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Unity/" rel="tag">Unity</a></li></ul>
    </div>
  </div>


    
      
  <div class="widget-wrap widget-recent-posts">
    <div class="widget-title"><span>Recent Posts</span></div>
    <div class="widget-inner">
      <ul>
        
          <li>
            <a href="/2023/01/31/npr-paint/">风格化场景后处理</a>
          </li>
        
          <li>
            <a href="/2023/01/29/procedural-terrain/">程序化岩石包边</a>
          </li>
        
          <li>
            <a href="/2022/12/27/npr-water/">移动端风格化SSR水体</a>
          </li>
        
          <li>
            <a href="/2021/08/25/road-editor/">路网生成器</a>
          </li>
        
          <li>
            <a href="/2021/03/06/double-aniso-silk/">双层高光丝绸</a>
          </li>
        
      </ul>
    </div>
  </div>

    
      
  <div class="widget-wrap widget-archive">
    <div class="widget-title"><span>Archive</span></div>
    <div class="widget-inner">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/">2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/">2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/">2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/">2020</a></li></ul>
    </div>
  </div>


    
</div>

<div id="backtop"><i class="icon icon-arrow-up"></i></div>
            </aside>
            
        </div>
    </div>

    <footer class="footer">
    <div class="footer-wave">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="#3c4859" fill-opacity="1" d="M0,160L60,181.3C120,203,240,245,360,240C480,235,600,181,720,186.7C840,192,960,256,1080,261.3C1200,267,1320,213,1380,186.7L1440,160L1440,320L1380,320C1320,320,1200,320,1080,320C960,320,840,320,720,320C600,320,480,320,360,320C240,320,120,320,60,320L0,320Z"></path></svg>
    </div>

    <!-- Please do not remove this -->
    <!-- 开源不易，请勿删除 -->
    <div class="footer-wrap">
        <div class="footer-inner"> 
            Joon Portfolio &copy; 2023<br>
            Powered By Hexo · Theme By <a href="https://linhong.me/" target="_blank">Aomori</a> · <a href="https://github.com/lh1me/hexo-theme-aomori" target="_blank">Github</a>
        </div>
    </div>

</footer>

<script type="module" src="https://unpkg.com/ionicons@6.0.2/dist/ionicons/ionicons.esm.js"></script>






<script src="/dist/build.js?1654266144177.js"></script>


<script src="/dist/custom.js?1654266144177.js"></script>













</body>

</html>